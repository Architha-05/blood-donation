<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BloodConnect – Recipient Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50">

<!-- Header -->
<header class="bg-white shadow-sm border-b border-gray-200">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <div class="flex items-center space-x-4">
      <h1 class="text-2xl font-bold text-red-600">BloodConnect</h1>
      <span class="px-2 py-1 border border-blue-200 text-blue-600 rounded">Recipient</span>
    </div>
    <div class="flex items-center space-x-4">
      <span id="userFullName" class="text-gray-700"></span>
      <button id="logoutBtn" class="flex items-center space-x-2 border px-2 py-1 rounded text-gray-600 hover:bg-gray-100">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
             stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
             d="M17 16l4-4m0 0l-4-4m4 4H7"/></svg>
        <span>Logout</span>
      </button>
    </div>
  </div>
</header>

<!-- Body Content -->
<div class="max-w-7xl mx-auto px-4 py-8">

  <!-- Emergency Section -->
  <div class="mb-8">
    <div class="border border-red-200 bg-red-50 p-4 rounded flex justify-between items-center">
      <div>
        <p class="font-semibold text-red-800">Need Blood Urgently?</p>
        <p class="text-sm text-red-700 mt-1">Send immediate alerts to compatible donors in your area.</p>
      </div>
      <div class="flex gap-2">
        <button id="emergencyBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">Emergency Request</button>
        <button id="openRequestModal" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">Request Blood</button>
      </div>
    </div>
  </div>

  <!-- Grid Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

    <!-- Profile -->
    <div class="bg-white shadow rounded-lg p-6 text-center space-y-4">
      <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5.121 17.804A9 9 0 1121 12"/>
        </svg>
      </div>
      <h3 id="profileName" class="font-semibold text-lg"></h3>
      <p id="profileEmail" class="text-gray-600"></p>
      <span id="profileBT" class="mt-1 px-2 py-1 bg-blue-600 text-white rounded text-sm"></span>
      <div class="border-t pt-4 space-y-2 text-sm text-left">
        <div><p class="text-gray-600">Phone</p><p id="profilePhone" class="font-medium"></p></div>
        <div><p class="text-gray-600">Location</p><p id="profileCity" class="font-medium"></p></div>
      </div>
      <button id="openProfile" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">Update Profile</button>
    </div>

    <!-- Main Content -->
    <div class="lg:col-span-3 space-y-8">

      <!-- Donor Search -->
      <div class="bg-white shadow rounded-lg p-6 space-y-6">
        <h3 class="text-lg font-medium">Find Blood Donors</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Blood Type</label>
            <select id="searchBT" class="w-full p-2 border rounded">
              <option value="">Select</option><option>A+</option><option>A-</option>
              <option>B+</option><option>B-</option><option>AB+</option><option>AB-</option>
              <option>O+</option><option>O-</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">City</label>
            <input id="searchLoc" type="text" class="w-full p-2 border rounded"/>
          </div>
          <div class="flex items-end">
            <button id="searchBtn" class="w-full bg-blue-600 text-white rounded py-2">Search</button>
          </div>
        </div>
        <div id="donorResults" class="space-y-4"></div>
      </div>

      <!-- Blood Banks -->
      <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-medium mb-4">Nearby Blood Banks</h3>
        <div id="bankList" class="space-y-4"></div>
      </div>
      <!-- Responses -->
<div class="bg-white shadow rounded-lg p-6">
  <h3 class="text-lg font-medium mb-4">Responses from Donors</h3>
  <div id="responseList" class="space-y-4"></div>
</div>
<!-- My Requests -->
<div class="bg-white shadow rounded-lg p-6">
  <h3 class="text-lg font-medium mb-4">My Blood Requests</h3>
  <div id="myRequestsList" class="space-y-4 text-sm text-gray-700"></div>
</div>
    </div>
  </div>
</div>

<!-- Modal Root -->
<div id="modalRoot"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC1femOc87pxd93vXHhulZjc5Q_DVyYOao",
    authDomain: "blood-donation-35854.firebaseapp.com",
    projectId: "blood-donation-35854",
    storageBucket: "blood-donation-35854.appspot.com",
    messagingSenderId: "652833129038",
    appId: "1:652833129038:web:da042bd0e9d7685c9d791f"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let user = {}, donors = [], banks = [];

  auth.onAuthStateChanged(async currentUser => {
  if (!currentUser) return location.href = 'login.html';
  const email = currentUser.email;
  const snapshot = await db.collection("recipient").where("email", "==", email).get();
  if (snapshot.empty) return alert("No recipient found");
  user = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
  renderProfile();
  fetchDonors();
  fetchBanks();
  fetchResponses();
  fetchMyRequests(); // ✅ This was missing
});

  function renderProfile() {
    document.getElementById('userFullName').innerText = user.fullName;
    document.getElementById('profileName').innerText = user.fullName;
    document.getElementById('profileEmail').innerText = user.email;
    document.getElementById('profilePhone').innerText = user.phone;
    document.getElementById('profileCity').innerText = user.city;
    document.getElementById('profileBT').innerText = `Type: ${user.bloodType}`;
  }

  document.getElementById('openProfile').onclick = () => {
    document.getElementById('modalRoot').innerHTML = `
      <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
          <h2 class="text-lg font-semibold mb-4">Update Profile</h2>
          <form onsubmit="event.preventDefault(); saveProfile()">
            <div class="mb-3"><label>Name</label><input id="updName" class="w-full border p-2 rounded mt-1" value="${user.fullName}" required></div>
            <div class="mb-3"><label>Phone</label><input id="updPhone" class="w-full border p-2 rounded mt-1" value="${user.phone}" required></div>
            <div class="mb-3"><label>City</label><input id="updCity" class="w-full border p-2 rounded mt-1" value="${user.city}" required></div>
            <div class="flex justify-end gap-2">
              <button type="button" onclick="document.getElementById('modalRoot').innerHTML=''" class="text-gray-500">Cancel</button>
              <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
            </div>
          </form>
        </div>
      </div>`;
  };

  async function saveProfile() {
    const updated = {
      fullName: document.getElementById('updName').value,
      phone: document.getElementById('updPhone').value,
      city: document.getElementById('updCity').value
    };
    await db.collection("recipient").doc(user.id).update(updated);
    Object.assign(user, updated);
    renderProfile();
    document.getElementById('modalRoot').innerHTML = '';
    alert("Profile updated!");
  }

  document.getElementById("emergencyBtn").onclick = async () => {
  await db.collection("requests").add({
  bloodType: user.bloodType,
  city: user.city,
  urgency: "Critical",
  recipientEmail: user.email,
  phone: user.phone,  // ✅ Add this
  timestamp: new Date()
});
  alert("Emergency request sent!");
};

  document.getElementById("openRequestModal").onclick = () => {
  document.getElementById("modalRoot").innerHTML = `
    <div class="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg w-full max-w-2xl p-6 border-2 border-orange-500">
        <h2 class="text-xl font-semibold text-orange-600 flex items-center mb-4">
          <span class="mr-2">⚠️</span> Blood Request Form
        </h2>
        <form id="requestForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium">Blood Type *</label>
              <select id="reqBloodType" class="w-full border rounded p-2" required>
                <option value="">Select blood type</option>
                <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
                <option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Urgency Level *</label>
              <select id="reqUrgency" class="w-full border rounded p-2" required>
                <option value="">Select urgency</option>
                <option>Low</option><option>Moderate</option><option>High</option><option>Critical</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium">Additional Information</label>
            <textarea id="reqInfo" rows="3" class="w-full border rounded p-2" placeholder="Any additional details about the request"></textarea>
          </div>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" onclick="document.getElementById('modalRoot').innerHTML=''" class="border px-4 py-2 rounded">Cancel</button>
            <button type="submit" class="bg-orange-600 text-white px-6 py-2 rounded">Submit Request</button>
          </div>
        </form>
      </div>
    </div>
  `;

  // Form submit handler
  document.getElementById("requestForm").onsubmit = async function (e) {
    e.preventDefault();
    try {
      await db.collection("requests").add({
        bloodType: document.getElementById("reqBloodType").value,
        urgency: document.getElementById("reqUrgency").value,
        info: document.getElementById("reqInfo").value,
        city: user.city,
        recipientEmail: user.email,
        phone: user.phone,
        fullName: user.fullName, // Ensure this is included
        timestamp: new Date()
      });

      alert("Request submitted successfully!");
      document.getElementById("modalRoot").innerHTML = "";
    } catch (err) {
      alert("Failed to submit request.");
      console.error(err);
    }
  };
};

  async function fetchDonors() {
    const snapshot = await db.collection("donor").get();
    donors = snapshot.docs.map(d => d.data());
    renderDonors(donors);
  }

  async function fetchBanks() {
    const snapshot = await db.collection("bloodbanks").get();
    banks = snapshot.docs.map(d => d.data());
    document.getElementById("bankList").innerHTML = banks.map(b =>
      `<div class="p-3 border rounded"><strong>${b.name}</strong><br><span class="text-gray-600">${b.location}</span></div>`
    ).join('');
  }

  document.getElementById('searchBtn').onclick = () => {
    const bt = document.getElementById('searchBT').value;
    const city = document.getElementById('searchLoc').value.trim().toLowerCase();
    const results = donors.filter(d =>
      (!bt || d.bloodType === bt) &&
      (!city || d.city.toLowerCase().includes(city))
    );
    renderDonors(results);
  };

  function renderDonors(data) {
  const container = document.getElementById('donorResults');
  container.innerHTML = '';

  if (data.length === 0) {
    container.innerHTML = `<p class="text-gray-500">No donors found.</p>`;
    return;
  }

  const firstThree = data.slice(0, 3);
  const remaining = data.slice(3);

  // Render the first 3 donors
  firstThree.forEach(d => {
    const card = document.createElement('div');
    card.className = "p-3 border rounded bg-blue-50";
    card.innerHTML = `
      <strong>${d.fullName}</strong><br>
      <span>${d.bloodType} | ${d.city}</span><br>
      <span class="text-gray-600">${d.phone}</span>
    `;
    container.appendChild(card);
  });

  if (remaining.length > 0) {
    const viewMoreBtn = document.createElement('button');
    viewMoreBtn.innerText = "View More";
    viewMoreBtn.className = "mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700";

    viewMoreBtn.onclick = () => {
      remaining.forEach(d => {
        const card = document.createElement('div');
        card.className = "p-3 border rounded bg-blue-50 mt-2";
        card.innerHTML = `
          <strong>${d.fullName}</strong><br>
          <span>${d.bloodType} | ${d.city}</span><br>
          <span class="text-gray-600">${d.phone}</span>
        `;
        container.appendChild(card);
      });

      viewMoreBtn.remove(); // ✅ properly removes the button now
    };

    container.appendChild(viewMoreBtn);
  }
}
  async function fetchResponses() {
  try {
    const responseList = document.getElementById("responseList");
    responseList.innerHTML = '';

    const responses = [];

    const snap1 = await db.collection("responses")
      .where("recipientEmail", "==", user.email)
      .get();
    snap1.forEach(doc => responses.push(doc.data()));

    const snap2 = await db.collection("responses")
      .where("requestedBy", "==", user.email)
      .get();
    snap2.forEach(doc => responses.push(doc.data()));

    if (responses.length === 0) {
      responseList.innerHTML = `<p class="text-gray-600">No responses yet.</p>`;
      return;
    }

    // Sort responses by respondedAt (newest first)
    responses.sort((a, b) => b.respondedAt?.toMillis() - a.respondedAt?.toMillis());

    responses.forEach(r => {
  const card = document.createElement('div');
  card.className = "border rounded p-4 bg-green-50";

  card.innerHTML = `
    <p class="font-medium text-green-800">🩸 ${r.bloodType} blood donation offer received!</p>
    <p class="text-gray-700">Donor: <strong>${r.donorName}</strong> (${r.donorEmail})</p>
    <p class="text-gray-600">📞 Contact: ${r.donorPhone || 'Not Available'}</p>
    <p class="text-gray-600">📍 Location: ${r.city}</p>
    <p class="text-sm text-gray-500">Responded on: ${r.respondedAt?.toDate().toLocaleString() || '---'}</p>
  `;
  responseList.appendChild(card);
});
  } catch (err) {
    console.error("Error fetching responses:", err);
  }
}
async function fetchMyRequests() {
  const container = document.getElementById("myRequestsList");
  container.innerHTML = "Loading...";

  try {
    const snap = await db.collection("requests")
      .where("recipientEmail", "==", user.email)
      .orderBy("timestamp", "desc")
      .get();

    if (snap.empty) {
      container.innerHTML = `<p class="text-gray-500">You have not made any blood requests yet.</p>`;
      return;
    }

    container.innerHTML = "";
    snap.forEach(doc => {
      const data = doc.data();
      const card = document.createElement("div");
      card.className = "border rounded p-4 bg-red-50";
      card.innerHTML = `
        <p class="font-medium text-red-700">🩸 ${data.bloodType} - ${data.urgency}</p>
        <p><strong>City:</strong> ${data.city}</p>
        <p class="text-sm text-gray-500">Requested on: ${data.timestamp?.toDate().toLocaleString() || "---"}</p>
        <button onclick="deleteRequest('${doc.id}')" class="mt-2 px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">Delete</button>
      `;
      container.appendChild(card);
    });
  } catch (err) {
    console.error("Error fetching my requests:", err);
    container.innerHTML = `<p class="text-red-500">Failed to load your requests.</p>`;
  }
}
async function deleteRequest(id) {
  const confirmDel = confirm("Are you sure you want to delete this request?");
  if (!confirmDel) return;

  try {
    await db.collection("requests").doc(id).delete();
    alert("Request deleted successfully.");
    fetchMyRequests(); // reload updated list
  } catch (err) {
    console.error("Error deleting request:", err);
    alert("Failed to delete request.");
  }
}
  document.getElementById("logoutBtn").onclick = () => {
    auth.signOut().then(() => location.href = "index.html");
  };
</script>
</body>
</html>
